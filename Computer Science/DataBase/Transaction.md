# 트랜잭션(Transaction)이란?

데이터베이스의 상태를 변화시키는 하나의 논리적 기능을 수행하기 위한 작업의 단위다.

여기서 데이터베이스의 상태를 변화시킨다는 의미는 질의어(SQL : SELECT, INSERT, DELETE, UPDATE)를 이용하여 데이터베이스에 접근하는 것을 의미한다. 

그리고 작업 단위는 사람이 정하는 기준에 따라 한꺼번에 모두 수행되어야 할 일련의 연산들을 뜻한다. 이러한 작업 단위를 일종의 작업의 흐름으로도 볼 수 있다.

---

<img width="821" alt="스크린샷 2023-08-05 오후 5 54 49" src="https://github.com/YongNyeo/TIL/assets/109174778/c9b4db02-19dd-4ee8-ac82-f89d2205cb44">

다음은 사용자의 요청부터 트랜잭션이 실행되기까지의 과정이다.

- 사용자의 특정 행동 요청을 클라이언트에서 받으면 데이터베이스 서버와의 연결이 필요하다.

- 이 연결을 위해 커넥션(미리 만들어 놓퓨  을 수 있다.)을 생성하여 커넥션과 DB사이의 세션을 만든다. 앞으로 해당 커넥션은 항상 해당 세션을 이용한다. 

- 세션은 트랜잭션을 시작하고, 커밋 또는 롤백을 통해 트랜잭션을 종료한다. 그리고 이후에 새로운 트랜잭션을 다시 시작할 수 있다.

- 사용자가 커넥션을 닫거나, 또는 DBA(DB 관리자)가 세션을 강제로 종료하면 세션은 종료된다.
 
   하나의 트랜잭션은 하나의 세션에서 이뤄진다.

---

### 트랜잭션 상태

![스크린샷 2023-08-05 오후 9 37 13](https://github.com/YongNyeo/TIL/assets/109174778/f0c953d8-afa1-426f-abba-7cf660ee4e1c)

- 활동(Active) : 트랜잭션이 실행 중인 상태
- 실패(Failed) : 트랜잭션 실행에 오류가 발생하여 중단된 상태
- 철회(Aborted) : 트랜잭션이 비정상적으로 종료되어 Rollback 연산을 수행한 상태
- 부분 완료(Partially Committed) : 트랜잭션의 마지막 연산까지 실행했지만, Commit 연산이 실행되기 직전의 상태
- 완료(Committed) : 트랜잭션이 성공적으로 종료되어 Commit 연산을 실행한 후의 상태 



## 🪗 ACID 

트랜잭션은 ACID라 하는 원자성(Atomicity), 일관성 (Consistency), 격리성(Isolation), 지속성(Durability)을 보장해야 한다.

1.  원자성(Atomicity)
> 트랜잭션 내에서 실행한 작업들은 마치 하나의 작업인 것처럼 모두 성공 하거나 모두 실패해야 한다.
 
2. 일관성(Consistency)
>모든 트랜잭션은 일관성 있는 데이터베이스 상태를 유지해야 한다. 예를 들어 데이터베이스에서 정한 무결성 제약 조건을 항상 만족해야 한다.

3. 격리성(Isolation)
> 동시에 실행되는 트랜잭션들이 서로에게 영향을 미치지 않도록 격리한다. 예를 들어 동시에 같은 데이터를 수정하지 못하도록 해야 한다. 격리성은 동시성과 관련된 성능 이슈로 인해 트랜잭션 격리 수준 (Isolation level)을 선택할 수 있다.
> 
> 트랜잭션 격리 수준으로는
> 
>  Isolation level READ UNCOMMITED(커밋되지 않은 읽기)
> 
>  READ COMMITTED(커밋된 읽기)
> 
>  REPEATABLE READ(반복 가능한 읽기)
> 
>  SERIALIZABLE(직렬화 가능) 으로 4가지가 있는데 일반적으로 READ COMMITTED(커밋된 읽기)를 사용한다. 더 자세한것은 추후에 공부해야겠다.

4. 지속성(Durability)
> 트랜잭션을 성공적으로 끝내면 그 결과가 항상 기록되어야 한다. 중간에 시스템에 문제가 발생해도 데이터베이스 로그 등을 사용해서 성공한 트랜잭션 내용을 복구해야 한다.

---
트랜잭션은 하나의 거래를 안전하게 처리하도록 보장해주는 것인데, 이때 가장 중요한 기능인 commit과 rollback에 대해 알아보자.

### Commit
- 그림1)

![스크린샷 2023-08-06 오후 3 32 37](https://github.com/YongNyeo/TIL/assets/109174778/a3927240-fff6-46da-9fa4-60e64d2c9416)

세션1에서 새로운 유저를 insert한 상황이다. 

이때 커밋을 작업을 하지 않는다면, insert한 데이터는 임시정보로 취급된다. 본인 세션에서만 해당 데이터를 확인할 수 있고 세션2에서는 임시정보를 확인하지 못한다.

- 그림2)
  
![스크린샷 2023-08-06 오후 3 34 53](https://github.com/YongNyeo/TIL/assets/109174778/0b44f689-030d-4abe-b105-dd1488066847)

커밋을 하고나면 타 세션에서 확인할 수 있다.

> set autocommit true(false)를 통해 커밋 자동/수동 설정 가능한데, 보통은 false(수동)을 사용해야 트랜잭션의 제 기능을 할 수 있다.
---

### Rollback

![스크린샷 2023-08-06 오후 3 44 01](https://github.com/YongNyeo/TIL/assets/109174778/129c795d-7818-4765-ad9a-14bef264e998)

다음과 같이 일부 쿼리 오류로 인해 1가지 작업(돈 차감,증가)을 처음으로 돌려야하는 상황이 생길수 있다.

![스크린샷 2023-08-06 오후 3 45 07](https://github.com/YongNyeo/TIL/assets/109174778/a7bae788-be94-4e56-a669-f4d0342fe14c)

처음으로 롤백한 상황이다.



