# ⭐ chapter4 - Mysql 아키텍처

<img width="373" alt="스크린샷 2024-02-04 오전 11 55 10" src="https://github.com/YongNyeo/TIL/assets/109174778/1c351ab1-49f3-4053-84c8-70ab657518c1">

## 도입부 

MySql 아키텍처는 크게 Mysql 엔진과 스토리지 엔진 두개로 나눌 수 있다. 

Mysql엔진은 DBMS의 '두뇌' 역할을 한다고 볼 수 있다. 

반면 스토리지 엔진은 실제 데이터와 연결된 부분으로 디스크에 데이터를 저장하거나 읽어오는 역할을 한다. 

mysql 엔진은 단 하나지만, 스토리지 엔진은 여러개를 동시에 사용할 수 있다. 

스토리지 엔진의 종류는  크게 InnoDB와 MyIsam 으로 나뉘는데, InnoDB 가 중점적으로 사용되고 InnoDB 기준으로 정리할 생각이다.

---
# Mysql Engine Architecture

## 🥇 스레드

포그라운드 스레드/백그라운드 스레드로 나뉜다. 둘 사이에 캐시 스레드가 존재해서 효율성을 올려준다. 

포그라운드(Foreground) 스레드 

- 사용자 요청에 따라 포그라운드 스레드가 먼저 동작을 한다.(앞단)
- 포그라운드 스레드는 데이터 버퍼나 캐시까지만 쓰기 작업을 하고, 디스크 기록하는 동작은 백그라운드 스레드가 처리한다.
- 즉, 포그라운드 스레드는 디스크 단에서 '읽기' 작업만 하고 버퍼/캐시 단에서 '쓰기'작업을 할 수 있다. 

백그라운드(Background) 스레드

- 로그를 디스크로 기록한다.
- 디스크의 데이터를 버퍼로 읽어온다.
- 버퍼 풀의 데이터를 디스크에 기록한다.
- 인서트 버퍼 병합
- 잠금이나 데드락 모니터링한다.
- 즉 디스크 단에서 '쓰기' 작업을 주로 담당한다.

> '읽기'스레드와 '쓰기'스레드의 개수를 설정할 수 있는데, 백그라운드에서는 쓰기 스레드에 대한 최적화 작업이 중요하다.

---

## 2️⃣ 메모리 할당 및 사용 구조

<img width="580" alt="스크린샷 2024-02-04 오후 12 31 48" src="https://github.com/YongNyeo/TIL/assets/109174778/e9b0dda4-1991-4e8d-826a-0b715cdcd139">

메모리 구조는 크게 글로벌 영역과 로컬(커넥션/세션) 메모리 영역으로 나눈다. 

많은 스레드가 공유하는 공유 가능한지에 따라 구분한다.

_글로벌 메모리 영역_ 은 모든 스레드가 모든 데이터를 공유한다.

_로컬 메모리 영역_ 은 대부분 클라이언트 스레드가 쿼리를 처리하는데 사용되는 메모리 영역이다.

위 그림만 보아도 쿼리를 처리하는 조인, 정렬, 네트워크, 리드 버퍼가 있다.  대부분 쿼리가 필요할 때만 메모리를 할당하고 평소에는 할당조차 되어있지 않을 수 있다. 

---

## 3️⃣ 플로그인 스토리지 엔진 모델

우리가 어떤 검색을 할 때, 실질적으로는 Mysql엔진에서 스토리지 엔진으로 넘어가야한다. (이 때 핸들러라는 것을 통해 넘어간다)

이 때 데이터를 빨리 찾기 위해 필요한 작업은 대부분 Mysql엔진(두뇌)에서 한다.

mysql엔진에서는 검색이나 특수한 작업을 위한 플러그인 형태를 개발해서 사용할 수 있다. 

실제로 이미 많이 지원이 되고 있다. ex) 비밀번호 검증, 커넥션 제어 등

<img width="723" alt="스크린샷 2024-02-04 오후 12 43 19" src="https://github.com/YongNyeo/TIL/assets/109174778/8328873c-68ce-46ae-81d8-e3b795213372">

---

## 4️⃣ 컴포넌트

8.0 버전부터 플러그인 아키텍처 -> 컴포넌트 아키텍처 지원한다.

플러그인은 플러그인끼리 통신이 불가하고, 캡슐화가 되어있지 않다. 

---

## 6️⃣ 쿼리 실행구조


1. 쿼리 파서

쿼리 파서를 통해 mysql이 인식할 수 있는 최소단위로 분리해 트리형태로 만든다. 여기서 기본 문법 오류도 잡는다.

2. 전처리기

트리 기반으로 쿼리의 구조적 문제를 확인한다. 테이블명이나 개체를 매핑에 존재 여부를 확인한다.

3. 옵티마이저

쿼리 문장을 저렴한 비용으로 가장 빠르게 처리할지를 결정하는 역할로, '두뇌'라는 이름에 가장 걸맞는 기능이다.

예를 들면 옵티마이저가 회사 경영진이고  실행 엔진은 중간관리자 , 헨들러는 업무의 실무자 정도로 볼 수 있겠다 .

---

## 7️⃣ 스레드 풀

일반적으로 스레드풀은 cpu 코어 개수와 맞추는것이 좋다. 그 이하로 제한하는 것이 좋다.

---

## 8️⃣ 트랜잭션 지원 메타데이터

8.0 이전의 버전에서, 테이블 등 스키마 정보 변경시 트랜잭션에 따른 파일로 저장되어왔던 메타데이터가 정상적으로 변경되지 않는 문제가 있었다.

저장방식을 파일에서 InnoDB 스토리지의 테이블로 개선하면서 문제를 해결했다.
이걸 
