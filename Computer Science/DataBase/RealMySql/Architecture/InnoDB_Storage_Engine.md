# 🚡 Inno DB 스토리지 엔진 아키텍처

InnoDB는 Mysql 스토리지엔진중 유일하게 레코드락을 제공해서 동시성 처리가 가능하고 안정적이며 뛰어나다.

<img width="424" alt="스크린샷 2024-02-04 오후 2 35 12" src="https://github.com/YongNyeo/TIL/assets/109174778/510670c3-3bb6-4240-af2b-534f6041a6a1">

---

# 주요 특징 

1. PK (클러스터링)

다른 스토리지 엔진에서는 클러스터링 기능을 지원하지 않는다. 

2. 외래키

다른 스토리지 엔진에서는 FK를 지원하지 않고 InnoDB에서만 가능하다. 

단, 실무에서 FK를 사용하지 않는 경우가 다반사다. FK가 복잡하게 얽힐경우 한번 에러가 터져 전파가 생겼을 때 처리하기 매우 까다로움

---

## ⭐ 3. MVCC (Multi Version Concurrency Contoller)

mvcc는 트랜잭션의 격리수준과 관련된 기능이다.

InnoDB는 mvcc 이름 그대로 데이터에 대한 다양한 버전을 동시에 다룬다.

<img width="414" alt="스크린샷 2024-02-04 오후 3 00 04" src="https://github.com/YongNyeo/TIL/assets/109174778/f66435bc-5a0c-4a3a-b926-2b52dde7cd09">

위 그림은 테이블 생성후 홍길동이라는 값을 insert 하고 commit 까지 완료됐다.

InnoDB는 ACID를 보장하기에, 버퍼풀과 파일(디스크)은 동일하다고 가정한다.

<img width="403" alt="스크린샷 2024-02-04 오후 3 01 48" src="https://github.com/YongNyeo/TIL/assets/109174778/a83a4817-c44b-42fd-a594-3a09bc36dd66">

위 그림은 m_area 값을 서울 -> 경기 로 update 쿼리를 날렸고, 커밋은 하지 않은 상황이다.

버퍼풀의 값이 파일에 씌워짐은 보장하나, 값은 씌워지는 시점에 따라 다를 수 있다.

__그렇다면 가장 중요한 , 커밋을 하지 않은 상황에서 select 쿼리로 홍길동의 지역을 찾으면 값을 버퍼 풀 과 언두 로그 둘중 어디서 불라올까?__

_정답은 ..... 트랜잭션 격리 레벨에 따라 다르다!_

1. 만약 Read_uncommited 라면 커밋되지 않은 것도 읽을 수 있어서 버퍼 풀을  읽는다.

2. 만약 Read_Commited나 그 이상의 수준이라면(REPEATABLE 이상) 커밋된 부분만 읽는다. 따라서 언두 로그에서 값을 찾는다.

이렇게 MVCC를 통해 하나의 레코드에 대해 2개의 버전이 유지된다. 

커밋이 된다고 바로 언두 로그가 없어지지 않고, 언두 영역을 필요로하는 트랜잭션이 더는 없을 때 삭제된다.

---

4. 잠금 없는 일관된 읽기

InnoDB는 기본적으로 MVCC를 통해 잠금을 걸지 않고 읽기 작업을 수행한다.

언두로그라는 존재 때문에 가끔 mysql 서버가 느려지거나 문제가 발생할 수 있다. 

따라서 트랜잭션을 최대한 필요한 기능만 섞어 가볍게 가져가는 것이 좋다. 

---

5. 자동 데드락 감지(p104)

InnoDB는 내부적으로 교착상태에 빠지지 않도록 잠금 대기 목록을 그래프 형태로 관리한다. 

이 때 교착상태에 빠진 트랜잭션중 하나를 찾아 강제 종료한다.

__이 때 종료되는 기준은 '언두 로그 레코드를 더 적게 가진 트랜잭션' 이다__

롤백해도 될 내용이 적기 때문이라는 뜻이기에, 강제 롤백으로 서버의 부하도 줄일 수 있기 때문이다.

> 이러한 자동 데드락 감지에도 문제점이 있다. 데드락 감지도 결국 스레드를 이용하는데, 잠금 목록이 많은 상황에서 밀려들어오는 데이터 요청 스레드가 있다면 서버에 부하가 온다.
> 따라서 데드락 감지 스레드를 끄는 기능도 있다. 하지만 이러면 데드락 처리가 어려운데, 이를 위해 데드락 timeout기능으로 일정시간이 지나면 자동으로 요청 실패로 롤백을 만들 수 있다.
> 실제로 데드락 감지 끄기 기능의 탄생은 구글은 PK기반 조회 변경이 많은데,데드락 감지 스레드로 인해 성능 저하가 심해, 오라클에 요청해서 mysql에 추가된 기능이다

데드락은 개념적으로 정리된 내용도 많으므로 따로 더 공부하기. 

---

## ⭐ 6. InnoDB 버퍼 풀 
Inno DB 의 가장 핵심적인 부분으로, 디스크 데이터파일이나 인덱스 정보를 메모리에 캐시해두는 공간이다.  쓰기 지연 역할을 통해 일괄 처리 또한 가능하다.

### 캐싱

__버퍼풀의 메모리 공간을 효율적으로 사용하는 것이 mysql 아키텍처에서 굉장히 중요한 부분이다__

그렇기에 버퍼풀은 조금 더 세부적으로 나뉠 수 있다. 

- 플러시 리스트 : 실제 데이터로 채워지지 않는 비어있는 페이지 목록. 쿼리로 디스크에서 새롭게 데이터를 불러올때 사용
- LRU 리스트 : Old 서브 리스트 -> 디스크에서 불러온 페이지를 최대한 메모리에 유지해 디스크 읽기를 최소화 하기 위해
- 프리(MRU) 리스트 : New 서브 리스트
<img width="717" alt="스크린샷 2024-02-04 오후 10 53 54" src="https://github.com/YongNyeo/TIL/assets/109174778/bce24630-4bcc-45ea-839d-e1edcac3bfa0">

LRU에서 데이터가 읽히면 MRU 헤더부분으로 이동한다. 즉 MRU가 우선순위가 더 높다고 할 수 있고, MRU와 LRU는 서로 경쟁하면서 이동한다.

LRU에서 끝으로 밀려난 데이터는 버퍼풀에서 제거하게된다. 필요 데이터가 자주 접근된다면, 인덱스키를 어댑티브 해시 인덱스에 추가한다.

---

### 버퍼링

지금까지 버퍼 풀의 캐싱 기능을 알아보았는데, 이제 버퍼풀의 또다른 기능 '버퍼링'에 대해 알아보겠다. 


---

## 리두 로그 vs 언두 로그

리두로그 -> 바뀐 값을 저장. 즉 데이터 변경 중 시스템 비정상적 종료시, 변경 사항을 저장하고자 사용

언두 로그 -> 바뀌기 전 값을 이용. 롤백할 때 사용


---

## 어댑티브 해시 인덱스

InnoDB 스토리지 엔진에서 자체적으로 자주 사용하는 데이터에 대해 인덱스를 생성한다.ㅂ
