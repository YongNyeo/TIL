#  전송계층 (TCP/UDP)

지난 3계층까지 정리하면서 mac주소, ip주소에 대해 중점적으로 공부하면서 거리가 먼 기기에게 어떻게 이동하는지에 대해 알아보았다.

#### 1~3 계층의 패킷들에 각각 담은 정보는 주로 이동을 위한 정보들이 많다.(물론 제어 기능 등 여러가지 있지만..)

#### 반면 전송 계층에는 기기에게 전달되어야 하는 '정보 그 자체'가 많이 들어있다. 가볍게 얘기하면 통신방법(UDP/TCP),flag 등...

[TCP](#💡_TCP)

[UDP](#💡_UDP)

---

## 💡 TCP

   <img width="559" alt="스크린샷 2023-07-31 오후 5 24 55" src="https://github.com/YongNyeo/TIL/assets/109174778/bc9a571c-ed02-4a5b-ba31-c9cd8904c403">
   
- 가상 회선 방식을 이용한다.
- 각 데이터는 정해진 순서대로 규칙에 따라 이동하기에 매우 안정적이다
- 모든 패킷이 도착하면 회선이 해제된다.

이렇게 통신을 할때 3-way handshaking 을 통한 연결이 필요하다.

---
### 3 way-handshaking

<img width="641" alt="스크린샷 2023-07-31 오후 5 28 31" src="https://github.com/YongNyeo/TIL/assets/109174778/ee8875e6-928a-43ff-a5e6-918abd1ac8f8">

- SYN - Synchronization(동기화)은 TCP 연결시 처음에 필요한 과정이다. 세션 연결을 위해 임의의 시퀀스 번호를 보낸다.
- 다음에 서버가 SYN+ACK을 보낸다. 이때 SYN과 ACK 플래그를 둘다 1 상태로 보내게 되면 연결을 허락한다는 신호다.
- 이제 클라이언트가 서버로 ACK를 다시 보내면 세션이 연결된다.

#### 여기까지만 봐도 TCP가 꽤 깐깐하다는걸 알 수 있다. 

---

하지만 4계층에서 TCP방식으로 세그먼트(4계층의 패킷이름)을 보낼때는 더 지켜야할것이 많다.

<img width="657" alt="스크린샷 2023-07-31 오후 5 36 45" src="https://github.com/YongNyeo/TIL/assets/109174778/621a5c8b-50b0-4aa4-97af-c9abcf84f82e">

### - 6개의 FLAG - URG,ACK,PSH,RST,SYN,FIN 
 TCP 세먼트 전달과 관련되어 TCP회선 및 데이터 관리 제어 기능을 하는 플래그다. 쉽게 말하면 TCP통신시 이게 어떤 데이터인지 간략하게 flag를 통해 설명해주는것이다.

    URG : Urgent의 약자로, 해당 비트를 1로 설정하면 해당 데이터는 긴급데이터로 인식되어 순서에 상관없이 먼저 송신된다.

    ACK: 아까 본 ACK number에 대한 설정유무 확인을 위한 플래그다. 1이 세팅되면 확인번호가 유효하고 0이면 확인번호가 X

    PSH: 수신측에 데이터 전달시, 버퍼링 없이 응용계층으로 바로 전달될수있도록 도와준다.

    FIN - Finish 는 세션을 종료할때 이용되는 플래그다. 4-handshaking 이라 해서 세션을 끊는 과정에 필요하다.
  
    RST - RECEIVE,ESTABLISHED 상태일때 RST 플래그를 1로 설정하면 모두 초기 LISTEN상태로 돌아간다. 즉 연결 확립된 회선을 강제로 초기화 하기위한 플래그다

    SYN은 위를 참조

- Checksum : 오류 검출을 위한 헤더다. 비트 단위로 쪼개서 하나하나 값을 비교하며 에러가 있는지 확인한다.

- Urgent Pointer : 아까 우리가 본 TCP HEADER URG Flag 가 1일때, 데이터 필드에서 어디까지가 긴급 데이터인지 알려주는 포인터다. URG가 설정된 경우 Urgent Pointer는 마지막 긴급 데이터 바이를 가리킨다.

- Window Size
  
  - 클라이언트와 서버가 통신할때 각자 데이터를 받을수 있는 양인 버퍼 크기가 정해져있다(일반적으로 클라이언트가 요청해서 받아오는 형식이라 더 큼).
  - 이 때 버퍼는 한정되어있는데, 데이터가 물밀듯이 들어오면? 에러가 생길것이다. 이러한것을 방지하기 위해 통신시 '나 이만큼 받을수 있어' 정도를 알려줄 수 있는 값이다.

---

## 💡 UDP

<img width="683" alt="스크린샷 2023-07-31 오후 5 53 16" src="https://github.com/YongNyeo/TIL/assets/109174778/b781c8a6-6800-466f-9918-aa805639f905">

- 데이터 그램 방식
- 비연결형 서비스라하는데, 순서가 보장되지 않고 도착여부를 확인할 수 없다.
- TCP는 1:1통신이지만 UDP는 1:1,1:N,M:N 모두 가능하다.
- 결과적으로 신뢰성은 낮지만 속도가 매우 빨라 채팅이나 게임서비스에 이용할 수 있다.
  
---

<img width="665" alt="스크린샷 2023-07-31 오후 5 58 50" src="https://github.com/YongNyeo/TIL/assets/109174778/4ee8a4ba-81fd-4369-a4ed-181b8316e91f">

#### TCP처럼 3way-handshaking 같은 작업이 필요하지 않다. 

---
그렇다면 세그먼트에는 무엇이 들어있을까?

<img width="733" alt="스크린샷 2023-07-31 오후 6 00 33" src="https://github.com/YongNyeo/TIL/assets/109174778/613dd8a9-032a-4a89-aab4-4d1095bd5c42">

송.수신 포트, 길이, 오류체크 checksum 4개가 전부다. 세그먼트 크기 자체가 매우작다.


---
결론: 뭐 어떤방법이 좋다 나쁘다보다는 자신의 목적에 따라 방법을 사용하면 될것 같다.
웹에서 사용하는 http 프로토콜은 버전마다 다르지만 tcp/udp를 모두 사용한다.

